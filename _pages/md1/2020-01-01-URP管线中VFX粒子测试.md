---
title: 《URP管线中的VFX粒子测试》
author: DH Wang
date: 1000-01-01
category: TA
layout: post
---

# Title


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/10/25/v.png)

官方文档中介绍设备机支持VFX粒子至少需要满足两个条件:
* 1、平台需要支持computershader。
* 2、支持着色器存储缓冲区对象SSBOs。如果平台支持SSBOs，它将返回一个大于0的值。


VFX粒子最初是在HDRP管线上使用的，所以在转URP时会有一些不同其中包括了节点、脚本属性绑定、管线设置等。VFX粒子系统可自定义节点类型。测试过程中遇到会有HDRP无法直接转URP的问题，还有打包真机效果会有拉伸现象，和部分华为机型不支持VFX等问题。如下：


## 1、HDRP转URP

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/10/25/hdrp.png)

图例为HDRP官方VFX粒子效果EllenHologram，该效果使用到副相机的Colorbuffer和Depthbuffer信息传递到VFX参数面板，由于HDRP直接提供了Camera参数即可通过脚本直接绑定获取即可，但URP则需要手动实现buffer传递。
除了脚本属性绑定参数不同外，HDRP内置一些Lit相关节点也无法使用（不过可以通过ShaderGraph自动实现自定义光照模型给URP使用）。


## 2、安卓机打包测试

现在各家gpu对computeshader有所差异所以在使用vfx的时候会有出现不兼容现象，当前测试的图形API使用OpenGLES3，测试过程中Build环境为Unity19.4.22f1并使用Visual Effect Graph 7.5.3且环境手动搭建安卓JDK和SDK环境打包出来能显示，使用Unity21.1.25f1和Hub提供的SDK及OPenJDK打包出来无法渲染（Visual Effect Graph 版本为11.0.0），测试使用的机型是”三星GalaxyS10 CPU高通 骁龙855”,该机型满足官方的配置要求（支持Computeshader和SSBOs）。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/10/25/conf.png)

由于部分华为机型不支持structbuffer（但可以通过不用结构体用原始数据类型替换），可通过如下函数查询是否支持（当前机型最大ComputerBuffer输入顶点数为4，华为CPU海思 麒麟 990E 和CPU海思 麒麟 820均为0即无法渲染）。


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/10/25/hua.png)

在通过打包后会发现效果出现拉伸现象即如下：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/10/25/bug.png)

造成该现象主要是VFX粒子系统的部分输出节点导致（也可能和Unity版本或VFX版本有关，即官方仍在优化兼容性和部分节点），通过打包测试发现造成该拉伸的原因如下:

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/10/25/bug2.png)

通过使用通用Mesh输出节点选择对应自带网格类型即可完成替换。（除了自带Quad节点无法使用，Cube等其他节点也会造成拉伸现象，均使用通用网格输出节点替换即可）。


# 总结：
1、Unity版本（或VFX版本）不同打包效果会受到影响
2、HDRP中部分节点及脚本属性绑定参数URP不支持
3、VFX粒子中部分节点会造成拉伸现象
4、华为部分机型不支持SSBOs即无法使用
5、。。。


更新：目前项目中已经在用VFX了，使用URP渲染管线，大多数设备可以使用目前华为机型和Mac上存在一定问题，mac上capacity超过1000的时候便会卡死。
