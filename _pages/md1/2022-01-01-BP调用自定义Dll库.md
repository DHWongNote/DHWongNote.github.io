---
title: 《BP调用自定义Dll库》
author: DH Wang
date: 1000-01-01
category: TA
layout: post
---

# 流程
蓝图调用DLL库中的函数主要是通过继承自'UBlueprintFunctionLibrary'的C++代码暴露出来。

## 1、封装自定义DLL
工程文件一般在项目文件夹路径（x64\Release\projname.dll）解决方案配置和平台为Release和x64.

目标文件
.h
``` 
#pragma once  

#define DLL_EXPORT __declspec(dllexport)	//shortens __declspec(dllexport) to DLL_EXPORT

#ifdef __cplusplus		//if C++ is used convert it to C to prevent C++'s name mangling of method names
extern "C"
{
#endif

	bool DLL_EXPORT getInvertedBool(bool boolState);
	int DLL_EXPORT getIntPlusPlus(int lastInt);
	float DLL_EXPORT getCircleArea(float radius);
	char DLL_EXPORT* getCharArray(char* parameterText);
	float DLL_EXPORT* getVector4(float x, float y, float z, float w);

#ifdef __cplusplus
}
#endif
```

.cpp
``` 
#include "pch.h"
#include "string.h"
#include "CreateAndLinkDLLFile.h"

 
bool getInvertedBool(bool boolState)
{
	return bool(!boolState);
}

//Exported method that iterates a given int value.
int getIntPlusPlus(int lastInt)
{
	return int(++lastInt);
}

//Exported method that calculates the are of a circle by a given radius.
float getCircleArea(float radius)
{
	return float(3.1416f * (radius * radius));
} 

//Exported method that adds a vector4 to a given vector4 and returns the sum.
float* getVector4(float x, float y, float z, float w)
{
	float* modifiedVector4 = new float[4];

	modifiedVector4[0] = x + 1.0F;
	modifiedVector4[1] = y + 2.0F;
	modifiedVector4[2] = z + 3.0F;
	modifiedVector4[3] = w + 4.0F;

	return (float*)modifiedVector4;
}
```
## 2、UE代码接入
新建C++类继承UBlueprintFunctionLibrary。

项目源文件
.h
``` 
#pragma once 
#include "CoreMinimal.h"
#include "Kismet/BlueprintFunctionLibrary.h"
#include "CreateAndLinkDLLTut.generated.h" 
UCLASS()
class UNREAL_PLAYGROUND_API UCreateAndLinkDLLTut : public UBlueprintFunctionLibrary
{
	GENERATED_BODY() 
public: 
	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool importDLL(FString folder, FString name);
 
	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool importMethodGetInvertedBool();

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static void BPDHPrint();

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool importMethodGetIntPlusPlus();

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool importMethodGetCircleArea();

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool importMethodGetCharArray();

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool importMethodGetVector4();
 
	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static bool getInvertedBoolFromDll(bool boolState);

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static int getIntPlusPlusFromDll(int lastInt);

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static float getCircleAreaFromDll(float radius);

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static FString getCharArrayFromDll(FString parameterText);

	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static FVector4 getVector4FromDll(FVector4 vector4);
 
	UFUNCTION(BlueprintCallable, Category = "My DLL Library")
		static void freeDLL(); 
};
```
.cpp
```
// Fill out your copyright notice in the Description page of Project Settings.


#include "Misc/Paths.h" 
#include "CreateAndLinkDLLTut.h" 

typedef bool(*_getInvertedBool)(bool boolState); // Declare a method to store the DLL method getInvertedBool.
typedef int(*_getIntPlusPlus)(int lastInt); // Declare a method to store the DLL method getIntPlusPlus.
typedef float(*_getCircleArea)(float radius); // Declare a method to store the DLL method getCircleArea.
typedef char*(*_getCharArray)(char* parameterText); // Declare a method to store the DLL method getCharArray.
typedef float*(*_getVector4)(float x, float y, float z, float w); // Declare a method to store the DLL method getVector4.

_getInvertedBool m_getInvertedBoolFromDll;
_getIntPlusPlus m_getIntPlusPlusFromDll;
_getCircleArea m_getCircleAreaFromDll;
_getCharArray m_getCharArrayFromDll;
_getVector4 m_getVector4FromDll;

void *v_dllHandle;

#pragma region Load DLL

// Method to import a DLL.
bool UCreateAndLinkDLLTut::importDLL(FString folder, FString name)
{
	FString filePath = *FPaths::ProjectPluginsDir() + folder + "/" + name;

	if (FPaths::FileExists(filePath))
	{
		v_dllHandle = FPlatformProcess::GetDllHandle(*filePath); // Retrieve the DLL.
		if (v_dllHandle != NULL)
		{
			return true;
		}
	}
	return false;	// Return an error.
}
#pragma endregion Load DLL

#pragma region Import Methods

// Imports the method getInvertedBool from the DLL.
bool UCreateAndLinkDLLTut::importMethodGetInvertedBool()
{
	if (v_dllHandle != NULL)
	{
		m_getInvertedBoolFromDll = NULL;
		FString procName = "getInvertedBool";	// Needs to be the exact name of the DLL method.
		m_getInvertedBoolFromDll = (_getInvertedBool)FPlatformProcess::GetDllExport(v_dllHandle, *procName);
		if (m_getInvertedBoolFromDll != NULL)
		{
			return true;
		}
	}
	return false;	// Return an error.
}

// Imports the method getInvertedBool from the DLL.
void UCreateAndLinkDLLTut::BPDHPrint()
{ 
	UE_LOG(LogTemp, Warning, TEXT("Hello")); 
}
// Imports the method getIntPlusPlus from the DLL.
bool UCreateAndLinkDLLTut::importMethodGetIntPlusPlus()
{
	if (v_dllHandle != NULL)
	{
		m_getIntPlusPlusFromDll = NULL;
		FString procName = "getIntPlusPlus";	// Needs to be the exact name of the DLL method.
		m_getIntPlusPlusFromDll = (_getIntPlusPlus)FPlatformProcess::GetDllExport(v_dllHandle, *procName);
		if (m_getIntPlusPlusFromDll != NULL)
		{
			return true;
		}
	}
	return false;	// Return an error.
}

// Imports the method getCircleArea from the DLL.
bool UCreateAndLinkDLLTut::importMethodGetCircleArea()
{
	if (v_dllHandle != NULL)
	{
		m_getCircleAreaFromDll = NULL;
		FString procName = "getCircleArea";	// Needs to be the exact name of the DLL method.
		m_getCircleAreaFromDll = (_getCircleArea)FPlatformProcess::GetDllExport(v_dllHandle, *procName);
		if (m_getCircleAreaFromDll != NULL)
		{
			return true;
		}
	}
	return false;	// Return an error.
}

// Imports the method getCharArray from the DLL.
bool UCreateAndLinkDLLTut::importMethodGetCharArray()
{
	if (v_dllHandle != NULL)
	{
		m_getCharArrayFromDll = NULL;
		FString procName = "getCharArray";	// Needs to be the exact name of the DLL method.
		m_getCharArrayFromDll = (_getCharArray)FPlatformProcess::GetDllExport(v_dllHandle, *procName);
		if (m_getCharArrayFromDll != NULL)
		{
			return true;
		}
	}
	return false;	// Return an error.
}

// Imports the method getVector4 from the DLL.
bool UCreateAndLinkDLLTut::importMethodGetVector4()
{
	if (v_dllHandle != NULL)
	{
		m_getVector4FromDll = NULL;
		FString procName = "getVector4";	// Needs to be the exact name of the DLL method.
		m_getVector4FromDll = (_getVector4)FPlatformProcess::GetDllExport(v_dllHandle, *procName);
		if (m_getVector4FromDll != NULL)
		{
			return true;
		}
	}
	return false;	// Return an error.
}

#pragma endregion Import Methods

#pragma region Method Calls

// Calls the method getInvertedBoolFromDll that was imported from the DLL.
bool UCreateAndLinkDLLTut::getInvertedBoolFromDll(bool boolState)
{
	if (m_getInvertedBoolFromDll != NULL)
	{
		bool out = !bool(m_getInvertedBoolFromDll(boolState)); // Call the DLL method with arguments corresponding to the exact signature and return type of the method.
		return out;
	}
	return boolState;	// Return an error.
}

// Calls the method m_getIntPlusPlusFromDll that was imported from the DLL.
int UCreateAndLinkDLLTut::getIntPlusPlusFromDll(int lastInt)
{
	if (m_getIntPlusPlusFromDll != NULL)
	{
		int out = int(m_getIntPlusPlusFromDll(lastInt)); // Call the DLL method with arguments corresponding to the exact signature and return type of the method.
		return out;
	}
	return -32202;	// Return an error.
}

// Calls the method m_getCircleAreaFromDll that was imported from the DLL.
float UCreateAndLinkDLLTut::getCircleAreaFromDll(float radius)
{
	if (m_getCircleAreaFromDll != NULL)
	{
		float out = float(m_getCircleAreaFromDll(radius)); // Call the DLL method with arguments corresponding to the exact signature and return type of the method.
		return out;
	}
	return -32202.0F;	// Return an error.
}

// Calls the method m_getCharArrayFromDLL that was imported from the DLL.
FString UCreateAndLinkDLLTut::getCharArrayFromDll(FString parameterText)
{
	if (m_getCharArrayFromDll != NULL)
	{
		char* parameterChar = TCHAR_TO_ANSI(*parameterText);

		char* returnChar = m_getCharArrayFromDll(parameterChar);

		return (ANSI_TO_TCHAR(returnChar));
	}
	return "Error: Method getCharArray was probabey not imported yet!";	// Return an error.
}

// Calls the method m_getVector4FromDll that was imported from the DLL.
FVector4 UCreateAndLinkDLLTut::getVector4FromDll(FVector4 vector4)
{
	if (m_getVector4FromDll != NULL)
	{
		float* vector4Array = m_getVector4FromDll(vector4.X, vector4.Y, vector4.Z, vector4.W);

		return FVector4(vector4Array[0], vector4Array[1], vector4Array[2], vector4Array[3]);
	}
	return FVector4(-32202.0F, -32202.0F, -32202.0F, -32202.0F);	// Return an error.
}
#pragma endregion Method Calls
 
#pragma region Unload DLL

// If you love something  set it free.
void UCreateAndLinkDLLTut::freeDLL()
{
	if (v_dllHandle != NULL)
	{
		m_getInvertedBoolFromDll = NULL;
		m_getIntPlusPlusFromDll = NULL;
		m_getCircleAreaFromDll = NULL;
		m_getCharArrayFromDll = NULL;
		m_getVector4FromDll = NULL;

		FPlatformProcess::FreeDllHandle(v_dllHandle);
		v_dllHandle = NULL;
	}
}
#pragma endregion Unload DLL
```

## BP调用
编译过后直接调用C++提供的函数调用即可
ImportDll->Branch->Sequence->importMethodGetCircleArea->