---
title: 《SP内复现引擎内材质效果》
author: DH Wang
date: 1000-01-01
category: TA
layout: post
---


# Title
 
因为引擎自身对贴图的采样精度存在差异所以导致最后的效果存在不可避免的偏差，所以在保证原有的一些参数基础上新增一些辅助参数来尽量向引擎最终效果靠拢，在此之前需要先准备一下环境的初始化设置，如下。
 ![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/8/9/texset.png)
## 1、导入设置
配套文件一共有3个（NHXRoughness.exr、H3DStandard.glsl、h3dStandardShaderGUI.qml）
qml文件需要导入到sp中指定位置，贴图和Shader文件直接导入工程即可，注意顺序如下。


![GUI脚本qml格式](img/21/8/9/pos.png)
（1）找到SP安装目录(右键打开所在位置)然后根据以上路径找到custom-ui文件夹，在里面新建一个名为H3DStandard文件夹并将qml文件放入，注意H3DStandard大小写规范。
（2）注意应将qml先导入再导入shader文件，若打开SP后才导入qml文件则需重新打开工程文件（因为SP的脚本编译是在工程打开时进行的，后面导入不会编译）。

## 2、通道设置

SP中是通过通道来存放原始数据的所以需要准备以下对应通道。
Base Color(Albedo)、Opacity(Alpha)、Metallic(Metallic)、Roughness(Smoothness)、Normal(normal)、Height(height)、Emissive(Emission)、Blending Mask(detail mask)、User0:sRGB8(Detail)
 


## 3、数据设置
引擎计算的直接光的高光部分是通过一张NHXRoughness贴图来表现的细节，所以在SP中需要手动添加一张类似的NHX贴图来表现其效果。
![NHX图](img/21/8/9/nhx.png)

# 使用说明

1、通过相同的公式计算出相同的结果(mip)，但却经过不同的采样器得到不同的结果导致效果存在偏差所以提供一个可控参数(SkyMip后显示为GlossyEnvironmentReflection)来调整最后的效果，默认状态下该值为0但效果不一样。
2、基本参数中不建议对金属粗糙度进行参数控制，应该全部采用贴图输出信息，即通过通道来输出（因为SP中默认采样的输出值为常量0无法更改，且使用贴图控制更不容易出错且效果更接近，精确而优雅），若要使用则应该先保证通道是否开启不然调节参数始终为0并不会产生任何效果。

![SP默认参数值](img/21/8/9/defaultp.png)
3、若需要使用贴图填充图层，则需要将贴图的色彩空间设置为相应与引擎内部保持一致，并且填充图片尽量不要带alpha通道，单通道贴图请导入时设置为alpha类型资源，因为带Alpha的贴图导入SP引擎会自动处理到alpha输出通道导致最终表现结果不正确。

![效果图](img/21/8/9/h3dsp.png)


# Code
在SP中保存信息和数据读写操作是分离开的，也就是说需要分别处理，可通过配置文件（.ini）作为中转Qml文件同级目录下可以通过ini文件来访问数据，支持使用.value()或者.contain()方法，比如Value(“A”,”默认参数”)，更具体的可查看ps自带目录下的插件使用示例。注意一点在写脚本时需要注意大小写区分不然会报错滴。

## 回调方法
sp的回调方法一般嵌套在控件内部，绝大部分都需要通过自身传递来访问父类方法，而且大部分控件都是含有自己独有的属性，所以父类方法中需要特殊对待不同控件的不同属性，不能通用。部分示例如下

```
registerCallback(“”,func(){})


Rectangle{
Function Test(p)
{...
p.value
p.currentIndex
...
p.valueChanged.connect(function(){
})
p.currentIndexChanged.connect(function(){
})


}
AlgSlider{ Component.onCompleted:parent.initSlider(this)}
} 
```

SP中支持QT语言和Python脚本，官网中对python的介绍很少相反qt更适用于sp，虽然还是很少解释但好很多了已经。
支持数据类型有bool，int，string，alias，{}，var，[]，其中[]可以嵌套{}，{}可以嵌套本身但不能嵌套[]。
循环、判断都符合C标准，for支持迭代模式语法和foreach类似。

## Shader
在SP中的编写着色器使用的是glsl语言,需要注意的是注释中的：冒号需要注意，紧跟双斜杠，不然就是简单的注释，紧跟则是语义这也是一个细节。
```
//: metadata {
//:   "custom-ui": "H3DStandard/h3dStandardShaderGUI.qml"
//: } 
```
## SP里的坐标空间
因为不能确定是否存在模型空间和世界空间分离，所以对从V2F结构里拿到的数据进行测试，仅测试发现确实是一样的也就是说直接拿到的数据就是世界空间中的数据，因为在sp里也不存在移动操作，所以在着色器上就统一坐标空间为世界空间方便计算，下图是max中不同模型空间的两个茶壶，在SP中的兰伯特效果一致。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/8/9/coordsp.png)