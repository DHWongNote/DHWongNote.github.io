---
title: 《基于纹理的动态风场模拟》
author: DH Wang
date: 1000-01-01
category: TA
layout: post
---



# 基于纹理的动态风场模拟d
 
![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/wind.png)

实现风场模拟需要考虑以什么为载体，然后物体读取风场数据进行计算受风效果，目前采用了两种方式分别是基于flowmap的二维风场空间建模和基于体纹理的三维世界空间建模，如果风场数据简单或不需要三维高度信息科采用二维Flowmap从性能上比较省，但通过体纹理构建风场模型利用ComputeShader加速计算性能上也相对容易接受。


# 基于FlowMap思想的风场建模
 。。。
 这部分是二维空间的风场效果缺失了纵向维度的信息，效果对于一些简单的场景比较适用而且也是可以动态模拟的，原理也就是在一张rt上使用flowmap的原理模拟风向，这里只简单介绍下就行主要还是三维空间的模拟。
 
![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/1.png)


# 基于体纹理的动态风场建模

基于体纹理的风场模型的灵感来自于战神4中的风场系统，不过战神4的风场提供了六种类型的风源，目前这里只实现了前两种风源（如有需要可在此框架上搭建其余风源）

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/2.png)

## 1、可视化调试

由于模拟风的介质只能通过其余物体的表现才可查看风场数据是否正确，所以Debug调试工具变得尤为重要，下面参考战神4的实现方式做了一个简单的调试工具。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/3.png)

上图是战神4中利用2D切片的方式对风场模型进行了切割显示，可以看到风的方向。借鉴该方法在引擎通过ComputeShader对所建风场模型进行切割输出方向，并且提供了两种显示模式即格子显示和箭头绘制以及同时显示的方式，但由于在引擎内部如果全部绘制的话引擎将会变得很卡，这是由于箭头数量很多导致，目前场景采用了32*16*32大小的体纹理所以提供了一个参数来控制绘制箭头的数量。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/4.png)

下图显示了等比绘制场景中的风向，并且支持箭头随着风力的大小而进行动态变化。可视化3D volume风场和2D的风 切面是最直接有效的。可以很方便美术去布风，看效果，也方便程序去debug。图中绿色的格子和箭头的组合是由全部绘制到逐渐等比剔除一些中间过程的数据。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/5.png)

可视化2D的切面可以用向量更改wind的属性每个风源Motor通过锁定volume的Pivot位置可以导入自身数据到volume中风力的采样计算和显示，如下就是一个球形风源在场景中的表现，该风源的强度扰动也实现了三种方式，分别是
* （1）：通过噪波扰动来达到和主风强度形态保持一致，因为主风强度也是直接通过噪声扰动实现。
* （2）：通过Ramp图来实现类似一阵一阵的风力吹动的效果，此类效果就好比一阵一阵的海浪扰动。
* （3）：第三种方式可模拟技能释放人物交互等效果，实现方式和第二种类似也是通过制作贴图来完成唯一区别就是可以人为控制触发。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/6.png)

除此之外为了获得比较好的编辑效果，需要在场景中绘制每个风源的显示图标，但为了不引入多余贴图资源所以想获取引擎内部的贴图资源，之前在看到过大佬写的一篇系统内置系统图标大整理的文章（https://www.xuanyusong.com/archives/3777），但查找过后发现并没有风场的图标，于是便想到了通过截帧工具获取。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/7.png)

## 2、风源类型的搭建和交互

和unity里的WindZone做一个简单对比，unity中3D 在 Game Object > 3D Object > Wind Zone，提供了wind zone，但是类型较为单一，只提供了Direction和Spherical两种，差不多等价于战神里的 Directional 和 Omni。unity主要还是用压强来实现的，暴露的参数，Main（强度）近似战神Motor类型中的force。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/8.png)


首先是平行风的强度计算应该考虑是采用线性衰减还是普通的噪波扰动，这点可以根据效果来确立不过对比后发现平行风和主风的参数基本一致所以就将平行风和主风写为一个风源，其余平行风源可以考虑加上Cylinder风源或者Box风源等。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/9.png)

球形风源的搭建相比之下比较简单，基于每个球形风源Pivot向周围扩散，这里可以通过距离进行衰减计算，计算两个风源相交区域的风力大小和方向采用直接相加即可获得。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/wind.gif)

## 3、场景物体交互（以VFX新粒子系统为例）

通常情况线下，风可以是一个简单的正弦波，影响物体的摆动，但是为了创造一个更生动的世界，战神4写了一套完善的风力系统，可以作用的对象包括粒子、头发、树叶、皮毛、声音系统、布料这里的头发，树叶，皮毛，被集成在另一个系统中，子系统中处理局部空间的扰动。Unity的新GPU粒子系统（Visual Effect Graph）可以很方便的获取体纹理数据，同时也可以做出很惊艳的效果，这里通过很粗糙的搭建一个简易环境测试效果如下。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/10.png)

场景中的草和树叶均采用新GPU粒子系统制作，通过制作简单的属性绑定脚本接口将风场数据导入VFX中实现一些效果的搭建。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/11.png)

最后也可以使用repeat方式对风场纹理重复采样实现全局效果分布，使用纹理构建风场在着色器中可以快速模拟，当然这里实现的只是基于效果可控上的简单模拟，真实流体模拟计算量上又需要很大开销而且效果也不是很容易调。最后配合其他效果

 
![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/3/22/Fwind.gif)