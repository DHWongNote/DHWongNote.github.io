---
title: 《雨天积水效果系统》
author: DH Wang
date: 1000-01-01
category: TA
layout: post
---


# 雨天积水效果实现


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/rain.png)

“湿滑”的效果在PBR中分成四部分：Smoothness的提高，Specular Color的变亮以及GI Occlusion的降低和法线贴图比重的降低。首先，提高Smoothness是毫无疑问的，要让物体表面光滑首先要降低粗糙度，但是仅仅降低粗糙度是不行的，水停留在物体表面，这时反射光线的是水而不是物体本身，因此物体本身的漫反射会被降低，因此被淋水的物体看起来颜色会变深，根据物理反射定律，物体本身色彩无变化，即光线反射比例无变化的情况下，高光程度应提高，所以会表现出高光率提高的现象。

先分析整体效果，这里实现的整体效果可表现为几个阶段，雨滴湿润到地面湿滑再到地面积水的效果。雨滴和水花采用的是VFX粒子来制作同时闪点是直接动态生成的分形模型如需优化可考虑预计算效果再导入。最终一套雨天系统所需要的参数通过拓展ScriptableObject脚本保存为本地资产来集中控制。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/1.png)

# 一 地表材质修改

由于整个雨天是建立在修改场景通用材质PBR属性基础上的，所以在不增加通用材质新通道的前提下整个积水过程并没有做到由高度逐渐升高积水的效果，网上有一种做法是刷高度图，然后再叠加上纹理里的高度，能做到砖缝里水慢慢升高的效果。这种方法效果很好，但是缺点也很明显，需要美术刷，费人工，需要额外存储，甚至都还要加通道，而且还可能出错，比如刷到斜面等特殊场景物体高度信息不准确。
干脆就直接获取投影深度信息再加上全局的柏林噪声做扰动实现随机的地面湿润效果。如果不加噪声图则表现为有点类似海面或湖面的效果。如果对还原实际效果要求较高噪声图也可以直接动态根据地表坡度计算生成得到场景的高度信息。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/2.png)
![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/3.png)


这种方式只适用于地表等坡度较平缓的物体，不需要高精度贴图存储。但是，建筑的坡度计算就比较麻烦了，而且变化可能很剧烈，此外，建筑的细节法线也得考虑，比如屋顶的瓦片就是一个难题。所以，建筑最终就统一加了一层很浅的水膜，斜面和平面采样了两套不同的水波扰动参数，同时斜面的法线使用和扰动一样的噪声图，根据法线匹配相应的水流方向就可以了。


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/4.png)

绘制雨影黑白图原理就和引擎内自带实现ShadowMap原理类似，利用depth buffer得到世界空间里的点的位置，然后转到步骤1平行投影的坐标系下，再和雨影深度作比较即得到黑白图，白色表示被雨淋到的部分。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/5.png)

计算积水蒙版需要绘制一张自顶向下平行投影写深度的RT，这张RT精度可以根据投影区域选择合适的精度(下图展示了精度的差异)，也就是说雨影图覆盖的范围比较大时精度设高点，同时这张贴图的刷新频率也需要根据场景变化或相机移动很远才更新一次。下面分别是示例场景（俯视）和对应的深度图（本文默认投影算法采用的是ESM后续会比较一下采用其他算法得出效果）。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/6.png)

由于直接计算投影结果得到的地面湿润整体表现效果并不是很随机，所以再此基础上加了边界扰动的效果。因为是对整个场景的物体进行投射结果所以如果在一些较大场景或者存在一些规则的大物体（比如房屋，由下图可以看出树木等并不受太大影响）会存在平铺率过大的问题，所以参考网上的一种解决办法做随机UV扰动（后发现修改边界噪波图得出的结果也还能接受即保留了该功能）https://www.shadertoy.com/view/MdGGW3。 边界湿润随机过渡的效果图如下：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/7.png)

Shadowmap的原理很简单，实现也很简洁，但也存在像自阴影和阴影悬浮这样的固有缺陷，此外就是它只能产生非0即1的阴影值，在阴影边缘处不可避免地会产生锯齿。网上关于阴影计算的常见算法大致分为PCF（Percentage Closer Filtering）、ESM(Exponential Shadow Mapping)、VSM(Variance Shadow Mapping)等，同时网上这些算法的原理讲解也很多这里不再做赘述仅展示下各个算法在本效果中的一些表现差异。



![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/8.png)

这三种算法都属于预过滤的Shadowmap算法，将传统PCF算法中低效且与场景复杂度相关的模糊过滤部分转移到了Shadowmap生成阶段，并将模糊的时间复杂度转换为与Shadowmap尺寸相关。但这三种算法都无法避免漏光的问题，并且需要多通道浮点数纹理的支持。可以在log space下做，16bit的情况下c可以很大。但是模糊的时候不好用 bilinear，采样次数上升，耗时反而提升不大。不如PCF大力出奇迹，增加采样次数。Esm 可以在log space下做，16bit的情况下c可以很大。但是模糊的时候不好用 bilinear，采样次数上升，耗时反而提升不大。不如PCF大力出奇迹，增加采样次数。参考链接：
https://http.download.nvidia.com/developer/presentations/2006/gdc/2006-GDC-Variance-Shadow-Maps.pdf

https://jankautz.com/publications/esm_gi08.pdf

地面的湿润效果最关键的影响因素是Smoothness，最开始的雨点阶段采用了一张渐变图来控制雨滴湿润的消失程度同时也可考虑整体密集性是否需要表现随机化（根据效果确定是否需要将雨滴分布实现随机化，即融合之前计算的噪声遮罩结果），不过该效果使用了一些step函数在性能上可能会有一定消耗，同时湿润的效果还会体现在斜面上，开始阶段的湿润效果将斜面和平面分开计算，由于平面的打湿效果在斜面上表现不一样会非常陡峭，斜面采用的打湿效果是通过对一张水流图做蒙版遮罩的UV流动来实现的，打湿效果和水面效果是不一样的，具体效果和水流图如下（平面雨点和斜面水流）：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/9.png)

水面的反射和Ripple效果也是采样常见的方式实现，水面反射效果即新加了一个反射Cube并提供模糊参数和是否采样主法线的放射方向还是全局统一的一个反射方向。水面圆环状的涟漪波纹则是直接使用的圆形法线贴图做偏移，根据效果提供了两套重复采样的计算结果（其中一套提供了可旋转的参数控制），目的是增加水面波纹的多样性而不显得生硬且重铺率较大的效果。

# 二、雨滴及水花模拟

通常使用粒子模拟雨滴和水花会更加真实也可以很方便的在场景中做一些交互，但使用粒子也会存在一定的性能问题，这里使用了引擎新版本的GPU粒子来模拟实体雨水以及雨水掉在地上溅起的水花效果，同时使用了自定义着色器来表现水滴和水花的整体效果。下图展示的是不同粒子数的效果：

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/11.png)

上图中不同VFX的粒子数的效果，其中雨滴的效果是参考的nvidia测试包
https://developer.download.nvidia.cn/SDK/10/direct3d/screenshots/samples/Rain.html。
雨滴贴图随视角转动而切换，但由于官方包里使用的资源是切分后的贴图所以需要通过第三方的工具来操作大量的贴图资源，这里使用的是py的图像操作库函数拼合，考虑到每个雨滴是独立的个体所以在VFX粒子中使用了实例ID来对应采样偏移合并后的贴图UV，同时也可拓展VFX的属性绑定脚本来同步投射相机的区域范围，在一些较远的场景也可直接拷贝粒子参数即可。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/12.png)

引擎的VFX粒子是可以使用自定义的着色器的不过得使用ShaderGraph来实现,下图是雨滴的着色器实现：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/13.png)

水花和雨滴的着色器实现不同，演示中飞溅的水花是由粒子模拟的所以对应的着色器也相对简单,此外也尝试过使用序列帧的方式来模拟飞溅的水花效果，不过苦于找不到合适的序列帧最后的效果也就没那么好,如果通过使用dcc来模拟流体飞溅的渲染效果制作序列帧，这从制作上也增加了难度。所以最后还是选择牺牲性能使用粒子来模拟飞溅的水花。


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/14.png)

闪电的效果也是参考天刀中的分形的计算方式关于分形的概念，在此不再赘述。通俗地来讲，分形就是其每一部分与其整体拥有自相似性的性质。分子的布朗运动、花菜的形态，都具有类似的性质。这里计算闪电路径使用的是中点位移法，也就是对线段取中点后计算出一个随机的偏移值令其位移。我们可以将闪电划分成无数Z型和H型片段的集合，所谓Z型和H型，就是闪电路径拐点处有无分岔。而H型片段仅仅是比Z型多了一个顶点而已。写出生成片段的函数，随后递归调用，我们就得到了随机化的闪电路径，效果如下：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/15.png)

整个雨天涉及到的效果较多其中的参数也不好管理，最后还可以将风场接入进来，投影算法剔除不用的，简化代码和结构功能考虑删除一些不必要的功能或效果：比如是否仅投射范围生效、Debug显示、反射效果、垂面水流效果、水面是否使用主颜色（默认使用）、水面混合主法线(该功能在水的深浅变化出效果明显)、删除第二层水波等等，有些不必要计算造成了计算量开销较大的地方。此外还存在改进的方向就是水位积水应结合高度信息实现砖缝积水的效果，在打湿范围内计算contrast时调节积水范围应先由高度越大的地方Mask值越大。可参考：
https://seblagarde.wordpress.com/2013/01/03/water-drop-2b-dynamic-rain-and-its-effects/



## 

粒子模拟消耗还是挺大的，后面优化部分为将远处的粒子改为纺锤体雨幕，结合深度信息也可以调节较好的效果，

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/22/2/24/16.png)

纺锤体雨幕仅仅适合远处的效果因为近处很容易看出这是绘制在一个面片上的，所以通常需要结合粒子来使用。