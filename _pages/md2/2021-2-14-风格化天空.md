---
title: 《风格化天空》
author: DH Wang
date: 1000-01-01
category: TA
layout: post
---

# 天空球绘制


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/1.jpg)






## 太阳月亮
太阳月亮是通过贴图信息来绘制。关键在于如何确定方向UV，尝试过以屏幕空间UV来绘制但效果并不是很好，新方法是通过构建一个新的坐标系然后获取投影大小作为UV进行采样。

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/2.jpg)



如上图所示，其中图一是不同方向的新坐标系投影，其中在球面上大小是固定的，根据光源方向构建了一个坐标，然后相机根据该坐标求出投影作为UV，保证了UV是跟随光源始终是正对着球面（有点类似切线和副切线方向）。
具体代码参考如下：



![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/3.jpg)






## 天空色和水平线
天空色效果是通过默认球体的垂直方向UV值即uv.y来区分上下边界以及水平线效果的，为了更好的融合效果对该值进行了重映射，



![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/4.jpg)



地平线效果还进行了微调来配合 太阳/月亮 的 升起/降落（算法参考ShaderToy中的一个效果），具体实现细节图如下：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/5.jpg)






## 光晕（太阳/月亮）
为了呈现天空配色不显得单调所以通过光晕来增加细节，效果如下：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/6.jpg)



具体实现则是通过中心计算出法线信息，然后通过法线和光线的点乘得出一个范围然后再进行重映射局部优化。


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/7.jpg)



## 星空
星空效果是参考ShaderToy中的一个效果https://www.shadertoy.com/view/MtB3zW，然后再乘以SkyUV的蒙版取天上部分得到。通过月亮方向再对其进行一定程度的偏移，最后再通过脚本控制其渐入渐出的强度（根据时间确定）。



![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/8.jpg)






## 云层
云层效果分受光和不受光，其中受光部分则是直接参考光源方向的xz轴分量做偏移，通过控制偏移量来表现受光范围，需要通过边缘模糊参数来调节受光面的软硬程度。
         

![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/9.jpg)



具体的偏移细节可参考如下：


![](https://dhwblog-1301640854.cos.ap-chongqing.myqcloud.com/picture/img/21/2/14/10.jpg)



由于该偏移方法是全局来看的，所以还可以通过以太阳/月亮的水平分界限来进一步调和参数。

