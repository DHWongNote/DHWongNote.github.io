---
title: 【Embedded】Blinker Esp
author: DH Wang
date: 1000-01-01
category: Embedded
layout: post
---

小米开发者平台提供了很多接口和支持，可以接入物联网开发更多模块的功能和特性，买了块esp32接入小米后台，可以使用小爱音响和米家来控制自己的设备，例如外接了一个彩灯然后嵌入程序到esp32中再到小米平台接入blinker账号便可以语音控制彩灯的开关，这里需要需要注意接入小米后台的程序是需要写完整，不然也无法响应。
除了语音控制开关外，还可以定时执行代码，这下可以很方便设置起床灯啦。

使用的源代码如下：

```

#define BLINKER_WIFI 
#define BLINKER_MIOT_OUTLET

#include <Blinker.h>
char auth[] = "************";//点灯科技
char ssid[] = "CU_7k7k";
char pswd[] = "123456789.";

#define BUTTON_1 "btn-abc" 
#define LED_BUILTIN       4
#define DEV_BUILTIN       5


BlinkerButton Button1(BUTTON_1);

void button1_callback(const String & state)
{
    digitalWrite(DEV_BUILTIN, !digitalRead(LED_BUILTIN));
    digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN));
    
    BLINKER_LOG("get button state: ", state);

    if (state == BLINKER_CMD_BUTTON_TAP) {
        BLINKER_LOG("Button tap!");

        Button1.icon("fas fa-air-freshener");
        Button1.color("#FFFFFF");
        Button1.text("第一点灯程序");
        Button1.print();
    }
    
}

void dataRead(const String & data)
{
    BLINKER_LOG("Blinker readString: ", data);

    Blinker.vibrate();
    
    uint32_t BlinkerTime = millis();
    
    Blinker.print("millis", BlinkerTime);
}

//小爱电源类操作的回调函数:
//当小爱同学向设备发起控制, 设备端需要有对应控制处理函数 
void miotPowerState(const String & state)
{
    BLINKER_LOG("need set power state: ", state);

    if (state == BLINKER_CMD_ON) {
        digitalWrite(LED_BUILTIN, HIGH);
        digitalWrite(DEV_BUILTIN, HIGH);

        BlinkerMIOT.powerState("on");
        BlinkerMIOT.print();
    }
    else if (state == BLINKER_CMD_OFF) {
        digitalWrite(LED_BUILTIN, LOW);
        digitalWrite(DEV_BUILTIN, LOW); 

        BlinkerMIOT.powerState("off");
        BlinkerMIOT.print();
    }
} 
void setup()
{
    Serial.begin(115200);
    BLINKER_DEBUG.stream(Serial);

    pinMode(LED_BUILTIN, OUTPUT);
    pinMode(DEV_BUILTIN, OUTPUT);
    digitalWrite(LED_BUILTIN, LOW); 
    digitalWrite(DEV_BUILTIN, LOW); 

    Blinker.begin(auth, ssid, pswd);
    Blinker.attachData(dataRead);
    Button1.attach(button1_callback);
 //小爱同学务必在回调函数中反馈该控制状态 
 BlinkerMIOT.attachPowerState(miotPowerState);
 BlinkerMIOT.attachPowerState(miotPowerState);//注册回调函数
}

void loop()
{
    Blinker.run();
}
```

#   一、附件开发板管理网址
32: https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json


8266: http://arduino.esp8266.com/stable/package_esp8266com_index.json

blinker: https://diandeng.tech/doc/xiaoai

#   二、Blinker小爱同学接口函数

小爱设备配置
根据您定义的设备品类选择不同的参数用于配置Blinker

##  light:

#define BLINKER_WIFI
#define BLINKER_MIOT_LIGHT
 
##  outlet:

#define BLINKER_WIFI
#define BLINKER_MIOT_OUTLET
 
##  sensor:

#define BLINKER_WIFI
#define BLINKER_MIOT_SENSOR
 
multi_outlet:

#define BLINKER_WIFI
#define BLINKER_MIOT_MULTI_OUTLET
 
同步设备后可显示一个插座和四个插孔(名为插孔的插座设备)

##  fan:

#define BLINKER_WIFI
#define BLINKER_MIOT_FAN
 
##  aircondition:

#define BLINKER_WIFI
#define BLINKER_MIOT_AIR_CONDITION
 
设备设置后即可使用 小爱同学 BlinkerMIOT

#   三、小爱电源类的操作接口
当小爱同学向设备发起控制, 设备端需要有对应控制处理函数
BlinkerMIOT.attachPowerState()
用户自定义电源类操作的回调函数:

void miotPowerState(const String & state)
{
    BLINKER_LOG("need set power state: ", state);

    if (state == BLINKER_CMD_ON) {
        digitalWrite(LED_BUILTIN, HIGH);

        BlinkerMIOT.powerState("on");
        BlinkerMIOT.print();
    }
    else if (state == BLINKER_CMD_OFF) {
        digitalWrite(LED_BUILTIN, LOW);

        BlinkerMIOT.powerState("off");
        BlinkerMIOT.print();
    }
}

务必在回调函数中反馈该控制状态


    #define BLINKER_WIFI 
    #define BLINKER_MIOT_LIGHT

    #include <Blinker.h>
    char auth[] = "..";//点灯科技,阿里云密匙貌似不够
    char ssid[] = "CU_7k7k";
    char pswd[] = "123456789.";

    #define BUTTON_1 "btn-abc" 
    #define LED_BUILTIN       4
    #define DEV_BUILTIN       5


    BlinkerButton Button1(BUTTON_1);

    void button1_callback(const String & state)
    {
        digitalWrite(DEV_BUILTIN, !digitalRead(LED_BUILTIN));
        digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN));
        
        BLINKER_LOG("get button state: ", state);

        if (state == BLINKER_CMD_BUTTON_TAP) {
            BLINKER_LOG("Button tap!");

            Button1.icon("fas fa-air-freshener");
            Button1.color("#FFFFFF");
            Button1.text("第一点灯程序");
            Button1.print();
        }
        
    }

    void dataRead(const String & data)
    {
        BLINKER_LOG("Blinker readString: ", data);

        Blinker.vibrate();
        
        uint32_t BlinkerTime = millis();
        
        Blinker.print("millis", BlinkerTime);
    }

    void setup()
    {
        Serial.begin(115200);
        BLINKER_DEBUG.stream(Serial);

        pinMode(LED_BUILTIN, OUTPUT);
        pinMode(DEV_BUILTIN, OUTPUT);
        digitalWrite(LED_BUILTIN, LOW); 
        digitalWrite(DEV_BUILTIN, LOW); 

        Blinker.begin(auth, ssid, pswd);
        Blinker.attachData(dataRead);
        Button1.attach(button1_callback);
    }

    void loop()
    {
        Blinker.run();
    }
