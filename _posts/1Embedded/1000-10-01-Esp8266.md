---
title: 【Embedded】8266
author: DH Wang
date: 1000-01-01
category: Embedded
layout: post
---
#   一、ESP8266配网(使用手机APP来给模组配置)

假设已经开发了一个手机APP，这个APP完成的功能如下：

1、连接设备接的模块ESP8266生成的热点

2、给设备热点发送要连接的路由器的名字和密码

配网流程:

1、设备让ESP8266进入AP模式

设备MCU通过串口给ESP8266发送AT+CWMODE=2，让ESP8266进入AP模式。

如果进入AP模式成功，用手机可以搜索到ESP8266模块的热点信息。

2、用手机APP去连接这个热点

发送路由器ssid和password，假设格式如下:

ssid:“xxx”,password:“xxxx”

3、解析APP发过来的字符串格式

ESP8266串口收到ssid:“xxx”,password:"xxxx"这个字符串

设备MCU处理收到的这个字符串，将ssid和password提取出来。

分别保存到缓存区SSID、PASSWORD。

4、设备让ESP8266进入STA模式

设备MCU通过串口给ESP8266发送AT+CWMODE=1，让ESP8266进入STA模式。

5、设备连接路由器

拿保存在缓存区的SSID和PASSWORD，设备通过串口给ESP8266发送连接指令

AT+CWJAP=“SSID”,“PASSWORD”

6、连接公网服务器===>120.78.136.134:8888

AT+CIPSTART=“TCP”,“120.78.136.134”,9002

配网成功!如果以后不在初始化设置模式下，不会执行该流程，默认开机直接连接对应的热点和服务器。



#   二、ESP8266配网(使用上位机串口来给模组配置)

假设以及开发了一个上位机，这个上位机完成的功能如下：

1、上位机通过串口连接设备

2、具有设置wifi帐号和密码的功能(其实就是发送一条串口指令，带有wifi帐号和密码)

3、具有设置服务器ip和端口号的功能(其实就是发送一条串口指令，带有服务器ip和端口号)

配网流程：

1、直接让设备进入STA模式

上位机通过串口给接有ESP8266的设备发送AT+CWMODE=1，让ESP8266进入STA模式。

2、设备接收到上位机发送过来的进入STA模式的指令，透传给ESP8266，这时ESP8266如果设置成功，则处于STA模式

3、特定模式下(初始化设置)，线程等待上位机下发的指令

指令格式:

(1)设置wifi连接路由器

SSID:“xxxx”,“PASSWORD”:“xxxxx”

(2)设置wifi连接服务器

SERVER_IP:“xxx.xxx.xxx.xxx”,PORT:“xxxx”

4、设备接收到上位机下发的指令，进行解析后分别保存在缓存区中。

5、设备连接路由器

拿保存在缓存区的SSID和PASSWORD，设备通过串口给ESP8266发送连接指令

AT+CWJAP=“SSID”,“PASSWORD”

6、连接公网服务器===>120.78.136.134:8888

AT+CIPSTART=“TCP”,“120.78.136.134”,9002

配网成功!如果以后不在初始化设置模式下，不会执行该流程，默认开机直接连接对应的热点和服务器。

#   三、ESP8266配网(使用上位机网络TCP来给模组配置)

假设以及开发了一个上位机，这个上位机完成的功能如下：

1、上位机可以用TCP/IP连接wifi热点(ESP8266)===>需要知道esp8266的ip和端口号，通过window网络状态可以查到。

2、具有设置wifi帐号和密码的功能(其实就是发送一条串口指令，带有wifi帐号和密码)

3、具有设置服务器ip和端口号的功能(其实就是发送一条串口指令，带有服务器ip和端口号)

配网流程

设备端

1、直接让设备进入AP模式

上位机通过串口给接有ESP8266的设备发送AT+CWMODE=2，让ESP8266进入AP模式。

指令：AT+CWMODE=2

2、重启设备，确保AP模式设置成功

指令：AT+RST

3、开启多路连接

指令：AT+CIPMUX=1

4、为设备端创建热点

指令：AT+CWSAP=“WIFI名称”,“WIFI密码”,1,4

5、设备端启动服务器

指令：AT+CIPSERVER=1,8080

PC端:

1、事先需要让PC去连接wifi热点===>WIFI名称、WIFI密码

2、通过网络连接详情查看当前热点的IPv4服务器地址

3、PC端开发的上位机连接IPv4服务器地址，端口号就是设备端指定的端口号:8080

4、PC端开发的上位机下发指令给设备端

指令格式:

(1)设置wifi连接路由器

SSID:“xxxx”,“PASSWORD”:“xxxxx”

(2)设置wifi连接服务器

SERVER_IP:“xxx.xxx.xxx.xxx”,PORT:“xxxx”

设备端

1、解析字符串，如果含有SSID:“xxxx”,“PASSWORD”:“xxxxx”，取得ssid和password，保存到设备端的FLASH中，如果为其它，则设定接收出错的条件。

2、解析字符串，如果含有SERVER_IP:“xxx.xxx.xxx.xxx”,PORT:“xxxx”，取得server_ip和port，保存到设备端的FLASH中

，如果为其它，则设定接收出错的条件。

3、如果已经解析完两个字符串，自动重启，切换到STA模式，取出ssid和password，连接ap，连接成功后，却出flash中的server_ip和port，连接服务器，如果成功，则可进入数据上传，如果不成功，则返回ap连接，依次进行，直到成功后，此时程序中连接成功的标志会置一。

4、定时查询与服务器端确认是否连接成功，如果不成功，需要重新连接服务器。

5、可上传数据